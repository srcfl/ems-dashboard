# EMS Dashboard - Full Stack Docker Compose
# Run: docker-compose up --build
#
# Services:
# - frontend: React dashboard (port 3000)
# - sel-server: SEL automation server (port 3030)
# - postgres: PostgreSQL database (port 5432) - for future persistence
#
# Environment variables can be set in .env file

version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # Frontend - React Dashboard
  # ═══════════════════════════════════════════════════════════════════════════
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_SEL_API_URL=http://sel-server:3030
      - VITE_PRIVY_APP_ID_PROD=${VITE_PRIVY_APP_ID_PROD:-cmeh0sbu300bfju0b7gwxctnk}
      - VITE_PRIVY_APP_ID_DEV=${VITE_PRIVY_APP_ID_DEV:-cmdpnpacq01jtl40iof3ptm4u}
    depends_on:
      - sel-server
    networks:
      - ems-network

  # ═══════════════════════════════════════════════════════════════════════════
  # SEL Server - Automation Rules Engine
  # ═══════════════════════════════════════════════════════════════════════════
  sel-server:
    build:
      context: ./packages/sel-lang
      dockerfile: Dockerfile
    ports:
      - "3030:3030"
    environment:
      - PORT=3030
      - RUST_LOG=sel_server=debug,tower_http=debug
      # Telegram notifications (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      # Dry run mode (set to anything to enable)
      # - SEL_DRY_RUN=1
      # Database connection (for future persistence)
      - DATABASE_URL=postgres://sel:sel@postgres:5432/sel
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ems-network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════════
  # PostgreSQL - Database (for future persistence)
  # ═══════════════════════════════════════════════════════════════════════════
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=sel
      - POSTGRES_PASSWORD=sel
      - POSTGRES_DB=sel
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sel -d sel"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ems-network

networks:
  ems-network:
    driver: bridge

volumes:
  postgres_data:
